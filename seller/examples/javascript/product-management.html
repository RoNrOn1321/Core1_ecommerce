<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Product Management Example</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body>
    <div class="container mt-5">
        <h1>Product Management Example</h1>
        
        <div class="row mt-4">
            <div class="col-md-8">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h3>Products</h3>
                    <button class="btn btn-success" data-bs-toggle="modal" data-bs-target="#productModal" onclick="openProductModal()">
                        Add Product
                    </button>
                </div>
                
                <div class="mb-3">
                    <div class="row">
                        <div class="col-md-4">
                            <input type="text" class="form-control" id="searchInput" placeholder="Search products..." onkeyup="searchProducts()">
                        </div>
                        <div class="col-md-3">
                            <select class="form-control" id="statusFilter" onchange="filterProducts()">
                                <option value="">All Status</option>
                                <option value="draft">Draft</option>
                                <option value="published">Published</option>
                                <option value="archived">Archived</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <select class="form-control" id="categoryFilter" onchange="filterProducts()">
                                <option value="">All Categories</option>
                            </select>
                        </div>
                        <div class="col-md-2">
                            <button class="btn btn-primary w-100" onclick="loadProducts()">Refresh</button>
                        </div>
                    </div>
                </div>
                
                <div id="products-container">
                    <div class="text-center">
                        <div class="spinner-border" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                    </div>
                </div>
                
                <nav aria-label="Products pagination">
                    <ul class="pagination justify-content-center" id="pagination">
                    </ul>
                </nav>
            </div>
            
            <div class="col-md-4">
                <div class="card">
                    <div class="card-header">
                        <h5>Product Statistics</h5>
                    </div>
                    <div class="card-body" id="product-stats">
                        Loading...
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Product Modal -->
    <div class="modal fade" id="productModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="productModalTitle">Add Product</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="productForm">
                        <input type="hidden" id="productId">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="productName" class="form-label">Product Name *</label>
                                    <input type="text" class="form-control" id="productName" required>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="productSku" class="form-label">SKU</label>
                                    <input type="text" class="form-control" id="productSku">
                                </div>
                            </div>
                        </div>
                        
                        <div class="mb-3">
                            <label for="productDescription" class="form-label">Description</label>
                            <textarea class="form-control" id="productDescription" rows="3"></textarea>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label for="productPrice" class="form-label">Price *</label>
                                    <input type="number" class="form-control" id="productPrice" step="0.01" required>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label for="productComparePrice" class="form-label">Compare Price</label>
                                    <input type="number" class="form-control" id="productComparePrice" step="0.01">
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label for="productStock" class="form-label">Stock Quantity</label>
                                    <input type="number" class="form-control" id="productStock" value="0">
                                </div>
                            </div>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="productCategory" class="form-label">Category</label>
                                    <select class="form-control" id="productCategory">
                                        <option value="">Select Category</option>
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="productStatus" class="form-label">Status</label>
                                    <select class="form-control" id="productStatus">
                                        <option value="draft">Draft</option>
                                        <option value="published">Published</option>
                                        <option value="archived">Archived</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" onclick="saveProduct()">Save Product</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="../js/seller-api.js"></script>
    <script>
        const api = new SellerAPI();
        let currentPage = 1;
        let currentFilters = {};
        let categories = [];
        
        // Initialize page
        window.addEventListener('load', async () => {
            await loadCategories();
            await loadProducts();
            await loadProductStats();
        });
        
        async function loadCategories() {
            try {
                const response = await api.getCategories();
                categories = response.data;
                
                const categorySelects = ['categoryFilter', 'productCategory'];
                categorySelects.forEach(selectId => {
                    const select = document.getElementById(selectId);
                    categories.forEach(category => {
                        const option = document.createElement('option');
                        option.value = category.id;
                        option.textContent = category.name;
                        select.appendChild(option);
                    });
                });
            } catch (error) {
                console.error('Failed to load categories:', error);
            }
        }
        
        async function loadProducts(page = 1) {
            try {
                const filters = {
                    limit: 10,
                    offset: (page - 1) * 10,
                    ...currentFilters
                };
                
                const response = await api.getProducts(filters);
                displayProducts(response.data.products);
                displayPagination(response.data.total, response.data.limit, page);
                currentPage = page;
            } catch (error) {
                console.error('Failed to load products:', error);
                document.getElementById('products-container').innerHTML = '<div class="alert alert-danger">Failed to load products</div>';
            }
        }
        
        function displayProducts(products) {
            const container = document.getElementById('products-container');
            
            if (products.length === 0) {
                container.innerHTML = '<div class="alert alert-info">No products found</div>';
                return;
            }
            
            let html = '<div class="row">';
            products.forEach(product => {
                html += `
                    <div class="col-md-6 mb-3">
                        <div class="card">
                            <div class="card-body">
                                <div class="d-flex justify-content-between align-items-start">
                                    <div>
                                        <h6 class="card-title">${product.name}</h6>
                                        <p class="card-text text-muted small">${product.short_description || 'No description'}</p>
                                        <div class="mb-2">
                                            <span class="badge ${api.getProductStatusClass(product.status)}">${product.status}</span>
                                            <small class="text-muted ms-2">Stock: ${product.stock_quantity}</small>
                                        </div>
                                        <div>
                                            <strong>${api.formatCurrency(product.price)}</strong>
                                            ${product.compare_price ? `<small class="text-muted text-decoration-line-through ms-1">${api.formatCurrency(product.compare_price)}</small>` : ''}
                                        </div>
                                    </div>
                                    <div class="dropdown">
                                        <button class="btn btn-sm btn-outline-secondary dropdown-toggle" type="button" data-bs-toggle="dropdown">
                                            Actions
                                        </button>
                                        <ul class="dropdown-menu">
                                            <li><a class="dropdown-item" href="#" onclick="editProduct(${product.id})">Edit</a></li>
                                            <li><a class="dropdown-item" href="#" onclick="viewProduct(${product.id})">View</a></li>
                                            <li><hr class="dropdown-divider"></li>
                                            <li><a class="dropdown-item text-danger" href="#" onclick="deleteProduct(${product.id})">Delete</a></li>
                                        </ul>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            });
            html += '</div>';
            
            container.innerHTML = html;
        }
        
        function displayPagination(total, limit, currentPage) {
            const totalPages = Math.ceil(total / limit);
            const pagination = document.getElementById('pagination');
            
            let html = '';
            
            if (currentPage > 1) {
                html += `<li class="page-item"><a class="page-link" href="#" onclick="loadProducts(${currentPage - 1})">Previous</a></li>`;
            }
            
            for (let i = Math.max(1, currentPage - 2); i <= Math.min(totalPages, currentPage + 2); i++) {
                html += `<li class="page-item ${i === currentPage ? 'active' : ''}">
                    <a class="page-link" href="#" onclick="loadProducts(${i})">${i}</a>
                </li>`;
            }
            
            if (currentPage < totalPages) {
                html += `<li class="page-item"><a class="page-link" href="#" onclick="loadProducts(${currentPage + 1})">Next</a></li>`;
            }
            
            pagination.innerHTML = html;
        }
        
        async function loadProductStats() {
            try {
                const response = await api.getDashboard();
                const stats = response.data.products;
                
                const statsHtml = `
                    <div class="row text-center">
                        <div class="col-6">
                            <h4>${stats.total_products}</h4>
                            <small class="text-muted">Total Products</small>
                        </div>
                        <div class="col-6">
                            <h4>${stats.published_products}</h4>
                            <small class="text-muted">Published</small>
                        </div>
                        <div class="col-6 mt-3">
                            <h4>${stats.draft_products}</h4>
                            <small class="text-muted">Drafts</small>
                        </div>
                        <div class="col-6 mt-3">
                            <h4 class="text-warning">${stats.low_stock_products}</h4>
                            <small class="text-muted">Low Stock</small>
                        </div>
                    </div>
                `;
                
                document.getElementById('product-stats').innerHTML = statsHtml;
            } catch (error) {
                console.error('Failed to load product stats:', error);
            }
        }
        
        function searchProducts() {
            const search = document.getElementById('searchInput').value;
            currentFilters.search = search || undefined;
            loadProducts(1);
        }
        
        function filterProducts() {
            const status = document.getElementById('statusFilter').value;
            const category = document.getElementById('categoryFilter').value;
            
            currentFilters.status = status || undefined;
            currentFilters.category_id = category || undefined;
            
            loadProducts(1);
        }
        
        function openProductModal(productId = null) {
            document.getElementById('productModalTitle').textContent = productId ? 'Edit Product' : 'Add Product';
            document.getElementById('productForm').reset();
            document.getElementById('productId').value = productId || '';
            
            if (productId) {
                loadProductForEdit(productId);
            }
        }
        
        async function loadProductForEdit(productId) {
            try {
                const response = await api.getProduct(productId);
                const product = response.data;
                
                document.getElementById('productName').value = product.name;
                document.getElementById('productSku').value = product.sku || '';
                document.getElementById('productDescription').value = product.description || '';
                document.getElementById('productPrice').value = product.price;
                document.getElementById('productComparePrice').value = product.compare_price || '';
                document.getElementById('productStock').value = product.stock_quantity;
                document.getElementById('productCategory').value = product.category_id || '';
                document.getElementById('productStatus').value = product.status;
            } catch (error) {
                console.error('Failed to load product for edit:', error);
                alert('Failed to load product details');
            }
        }
        
        async function saveProduct() {
            try {
                const productId = document.getElementById('productId').value;
                const productData = {
                    name: document.getElementById('productName').value,
                    sku: document.getElementById('productSku').value,
                    description: document.getElementById('productDescription').value,
                    price: parseFloat(document.getElementById('productPrice').value),
                    compare_price: document.getElementById('productComparePrice').value ? parseFloat(document.getElementById('productComparePrice').value) : null,
                    stock_quantity: parseInt(document.getElementById('productStock').value),
                    category_id: document.getElementById('productCategory').value ? parseInt(document.getElementById('productCategory').value) : null,
                    status: document.getElementById('productStatus').value
                };
                
                let response;
                if (productId) {
                    response = await api.updateProduct(productId, productData);
                } else {
                    response = await api.createProduct(productData);
                }
                
                bootstrap.Modal.getInstance(document.getElementById('productModal')).hide();
                await loadProducts(currentPage);
                await loadProductStats();
                
                alert(response.message);
            } catch (error) {
                console.error('Failed to save product:', error);
                alert('Failed to save product: ' + error.message);
            }
        }
        
        function editProduct(productId) {
            openProductModal(productId);
            new bootstrap.Modal(document.getElementById('productModal')).show();
        }
        
        async function viewProduct(productId) {
            try {
                const response = await api.getProduct(productId);
                const product = response.data;
                
                alert(`Product: ${product.name}\nPrice: ${api.formatCurrency(product.price)}\nStock: ${product.stock_quantity}\nStatus: ${product.status}`);
            } catch (error) {
                console.error('Failed to view product:', error);
                alert('Failed to load product details');
            }
        }
        
        async function deleteProduct(productId) {
            if (!confirm('Are you sure you want to delete this product?')) {
                return;
            }
            
            try {
                const response = await api.deleteProduct(productId);
                await loadProducts(currentPage);
                await loadProductStats();
                alert(response.message);
            } catch (error) {
                console.error('Failed to delete product:', error);
                alert('Failed to delete product: ' + error.message);
            }
        }
    </script>
</body>
</html>