<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Map Test - Leaflet with LocationIQ</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-50 p-8">
    <div class="max-w-2xl mx-auto">
        <h1 class="text-2xl font-bold mb-6">Leaflet Map Test</h1>
        
        <div class="bg-white rounded-lg shadow p-6">
            <div class="mb-4">
                <label class="block text-sm font-medium text-gray-700 mb-2">Search Address</label>
                <div class="relative">
                    <input type="text" id="searchInput" 
                           placeholder="Search for an address..."
                           class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent pr-20">
                    <button type="button" id="gpsButton" 
                            class="absolute right-2 top-1/2 transform -translate-y-1/2 px-3 py-1 text-xs bg-blue-600 text-white rounded hover:bg-blue-700">
                        üìç GPS
                    </button>
                </div>
            </div>
            
            <div id="map" class="h-64 border border-gray-300 rounded-lg mb-4"></div>
            
            <div class="grid grid-cols-1 gap-4 sm:grid-cols-2">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Address</label>
                    <input type="text" id="address" class="w-full px-3 py-2 border border-gray-300 rounded-lg" readonly>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">City</label>
                    <input type="text" id="city" class="w-full px-3 py-2 border border-gray-300 rounded-lg" readonly>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Province</label>
                    <input type="text" id="province" class="w-full px-3 py-2 border border-gray-300 rounded-lg" readonly>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Coordinates</label>
                    <input type="text" id="coordinates" class="w-full px-3 py-2 border border-gray-300 rounded-lg" readonly>
                </div>
            </div>
        </div>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
    <script>
        // Configuration
        const LOCATIONIQ_API_KEY = 'pk.bf8a6e86e506a6e6e3bfcdf6b4eedc2b'; // Replace with your actual API key
        const DEFAULT_LAT = 8.6220221; // Philippines default location
        const DEFAULT_LNG = 123.68469;
        
        let map;
        let currentMarker;
        
        // Initialize map
        function initMap() {
            map = L.map('map').setView([DEFAULT_LAT, DEFAULT_LNG], 13);
            
            // Add OpenStreetMap tiles (free, no API key required)
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '¬© OpenStreetMap contributors'
            }).addTo(map);
            
            // Add click event
            map.on('click', onMapClick);
        }
        
        function onMapClick(e) {
            const lat = e.latlng.lat;
            const lng = e.latlng.lng;
            
            // Remove existing marker
            if (currentMarker) {
                map.removeLayer(currentMarker);
            }
            
            // Add new marker
            currentMarker = L.marker([lat, lng]).addTo(map);
            
            // Update coordinates display
            document.getElementById('coordinates').value = `${lat.toFixed(6)}, ${lng.toFixed(6)}`;
            
            // Reverse geocode
            reverseGeocode(lat, lng);
        }
        
        async function reverseGeocode(lat, lng) {
            try {
                const response = await fetch(`https://us1.locationiq.com/v1/reverse.php?key=${LOCATIONIQ_API_KEY}&lat=${lat}&lon=${lng}&format=json&addressdetails=1`);
                const data = await response.json();
                
                if (data && data.address) {
                    const address = data.address;
                    
                    // Update form fields
                    document.getElementById('address').value = 
                        `${address.house_number || ''} ${address.road || address.street || ''} ${address.neighbourhood || ''} ${address.suburb || ''}`.trim();
                    document.getElementById('city').value = address.city || address.town || address.municipality || address.village || '';
                    document.getElementById('province').value = address.state || address.province || '';
                    
                    // Update search box
                    document.getElementById('searchInput').value = data.display_name || '';
                    
                    console.log('Reverse geocoding successful:', data);
                }
            } catch (error) {
                console.error('Reverse geocoding failed:', error);
                alert('Could not get address details. Please check your API key and internet connection.');
            }
        }
        
        async function searchLocation(query) {
            if (query.length < 3) return;
            
            try {
                const response = await fetch(`https://us1.locationiq.com/v1/search.php?key=${LOCATIONIQ_API_KEY}&q=${encodeURIComponent(query)}&format=json&limit=1&countrycodes=ph`);
                const data = await response.json();
                
                if (data && data.length > 0) {
                    const result = data[0];
                    const lat = parseFloat(result.lat);
                    const lng = parseFloat(result.lon);
                    
                    // Center map on search result
                    map.setView([lat, lng], 16);
                    
                    // Remove existing marker
                    if (currentMarker) {
                        map.removeLayer(currentMarker);
                    }
                    
                    // Add new marker
                    currentMarker = L.marker([lat, lng]).addTo(map);
                    
                    // Update coordinates
                    document.getElementById('coordinates').value = `${lat.toFixed(6)}, ${lng.toFixed(6)}`;
                    
                    // Update form fields
                    const addressParts = result.display_name.split(', ');
                    if (addressParts.length >= 3) {
                        document.getElementById('address').value = addressParts[0] || '';
                        document.getElementById('city').value = addressParts[1] || '';
                        document.getElementById('province').value = addressParts[2] || '';
                    }
                    
                    console.log('Search successful:', result);
                }
            } catch (error) {
                console.error('Location search failed:', error);
                alert('Search failed. Please check your API key and internet connection.');
            }
        }
        
        function getCurrentLocation() {
            const button = document.getElementById('gpsButton');
            
            if (!navigator.geolocation) {
                alert('Geolocation is not supported by this browser');
                return;
            }
            
            // Show loading state
            button.innerHTML = 'üîÑ GPS';
            button.disabled = true;
            
            navigator.geolocation.getCurrentPosition(
                (position) => {
                    const lat = position.coords.latitude;
                    const lng = position.coords.longitude;
                    
                    // Center map on user location
                    map.setView([lat, lng], 16);
                    
                    // Remove existing marker
                    if (currentMarker) {
                        map.removeLayer(currentMarker);
                    }
                    
                    // Add new marker
                    currentMarker = L.marker([lat, lng]).addTo(map);
                    
                    // Update coordinates
                    document.getElementById('coordinates').value = `${lat.toFixed(6)}, ${lng.toFixed(6)}`;
                    
                    // Reverse geocode
                    reverseGeocode(lat, lng);
                    
                    // Reset button
                    button.innerHTML = 'üìç GPS';
                    button.disabled = false;
                    
                    console.log('GPS location detected:', { lat, lng });
                },
                (error) => {
                    console.error('Geolocation error:', error);
                    let message = 'Could not get your location';
                    
                    switch(error.code) {
                        case error.PERMISSION_DENIED:
                            message = 'Location access denied by user';
                            break;
                        case error.POSITION_UNAVAILABLE:
                            message = 'Location information is unavailable';
                            break;
                        case error.TIMEOUT:
                            message = 'Location request timed out';
                            break;
                    }
                    
                    alert(message);
                    
                    // Reset button
                    button.innerHTML = 'üìç GPS';
                    button.disabled = false;
                },
                {
                    enableHighAccuracy: true,
                    timeout: 10000,
                    maximumAge: 300000 // 5 minutes
                }
            );
        }
        
        // Debounce function
        function debounce(func, delay) {
            let timeoutId;
            return function (...args) {
                clearTimeout(timeoutId);
                timeoutId = setTimeout(() => func.apply(this, args), delay);
            };
        }
        
        // Initialize when DOM is loaded
        document.addEventListener('DOMContentLoaded', function() {
            initMap();
            
            // Add event listeners
            document.getElementById('searchInput').addEventListener('input', 
                debounce((e) => searchLocation(e.target.value), 500)
            );
            
            document.getElementById('gpsButton').addEventListener('click', getCurrentLocation);
        });
    </script>
</body>
</html>